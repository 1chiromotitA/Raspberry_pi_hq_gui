# ラズパイのHQカメラモジュールを使ってGUIから撮影する

Raspberry pi（以下ラズパイ）はさまざまな外部モジュールが開発されており、モジュールを組み合わせることで単なる教育用シングルボードコンピュータの枠を超えて自分でいろいろな機能を開発することができることができるようになっています  

2020年に発売されたラズパイのHQカメラモジュールは、高画質とレンズ交換可能な筐体を生かして産業用でも活躍しているモジュールのひとつのようです  

しかしこれを個人で活かすのは存外難しく、スマホのようにビルトインのアプリが提供されているわけでもないので単純に写真を撮るということが難しいです    

センサーサイズが小さいので通常のカメラのレンズを流用すると望遠になるという特性もあるのですが、レンズのピント合わせがかなりファジーでレンズが交換可能であるという利点を活かすことも困難です  

そこで、**1.ピントを合わせて　2.GUIで写真を撮る**という機能を実現して普通に写真を撮ってみよう、というのがこのアプリです  

## 使い方
OpenCV,numpyを使用しているので事前にライブラリをインストールする必要があります  

ラズパイにOpenCVをインストールするのはやり方が色々あるようなのですが  

```sudo apt-get install python3-opencv```  

が一番簡単だと思います  
参考：[ラズパイの、あんだけ苦労したOpenCVが、たった一文で解決](https://ameblo.jp/araya-benki/entry-12714939931.html)

画面の解像度設定は1200×720で表示したときに都合良くなるように決め打ちで書いてしまっているので適宜コードを確認して、必要なら数字を変えて運用してください  

標準で実装されているraspistillなどと違ってVNCでカメラ画面を表示することができるので遠隔から大きな画面に映すこともできます  


![75a5a9225618b7f9d194c552a26cbcb2](https://user-images.githubusercontent.com/62862789/170587306-67ea97f7-f92a-461f-8ba8-a719356d0db1.jpg)

起動して”Start camera”をクリックするとこのような画面に移動します  

非常にシンプルですが一応

- メイン画面  
  画面内をクリックするとその地点のズーム画像をサブ画面に表示します  
  このとき、サブ画面の領域が画面外にはみ出す場合はクリックしても変更が行われません  
  録画中はリソース節約のため同様に反応しません

- サブ画面  
  ピント合わせがしやすいようにズーム画面を表示します  
  ズーム倍率は```ZOOM```から変更できます  
  
- RECボタン  
  ```RECORD_RESOLUTION```に合わせてH264（Mp4）で録画を開始します  
  録画フォーマットや録画品質もコードから変えることが可能です  
  
- CAPボタン  
  シャッターボタンです
  HQカメラのフル解像度で写真を撮影します  
  カメラモジュールによってコードの解像度を変更する必要があります  

- STOPボタン  
  録画中なら停止し、アプリを終了します  
  
- ピントインジケータ  
  ピントの合いを表示します  
  録画中はリソース節約のために停止します  

## こんな感じです


## 問題点、改善点

・マルチコア、マルチスレッド化してないので重いです  

  Picameraのサンプルコードにマルチスレッド化の例があるので上手く使えば高速化できるはずです  
 
 
・ カメラの撮影設定が完全にオート任せです  

  せっかくのGUIなので設定もGUIにつけたいところです  


・ おそらくPicameraではなくOpenCVで書いたほうが軽くなる  

  なぜかOpenCVだとRGB変換されない領域が発生し、解決策が見当たらなかったためPicameraで書いています  
  使用しているモニタが特殊なのでその関係かもしれません  
![1092a782d9596f74561f418e9e253d83](https://user-images.githubusercontent.com/62862789/170607265-f0a0835a-8222-4f62-a7ad-64f893cea053.png)


## 参考
[ラズパイの、あんだけ苦労したOpenCVが、たった一文で解決](https://ameblo.jp/araya-benki/entry-12714939931.html)  

[ピンボケ写真の判定方法](https://qiita.com/goodboy_max/items/a2d5dd89c4c5a8f2308a)

[python tkinterのクラス化手法によるGUI作成](https://memopy.hatenadiary.jp/entry/2017/06/08/194153)
